<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>翰林國小數學-5上AR-三角柱</title>
    
    <!-- 更新 A-Frame 版本 -->
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.0/dist/mindar-image-aframe.prod.js"></script>
    
    <!-- 添加額外的互動組件 -->
    <script src="https://raw.githack.com/donmccurdy/aframe-extras/master/dist/aframe-extras.loaders.min.js"></script>

    <style>
        body { 
            margin: 0; 
            overflow: hidden; 
            width: 100vw;
            height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            /* 确保安卓设备不会出现滚动条 */
            -webkit-overflow-scrolling: touch;
            position: fixed;
        }
        .a-enter-vr {
            display: none !important;
        }
        .a-canvas {
            width: 100% !important;
            height: 100% !important;
            position: absolute !important;
        }
        /* 修改按鈕容器樣式 - 提高安卓兼容性 */
        .button-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 9999;
            display: none; /* 初始時隱藏按鈕 */
            max-width: 300px;
            /* 移除可能不兼容的flexbox屬性 */
            /* 确保按钮在安卓设备上正确显示 */
            transform: translateZ(0);
            -webkit-transform: translateZ(0);
            /* 防止按钮跑到画面外 */
            max-height: calc(100vh - 40px);
            overflow: visible;
        }
        .yellow-row, .blue-row {
            margin-bottom: 10px;
            text-align: right;
            /* 确保行内容不会超出容器 */
            white-space: nowrap;
        }
        .ar-button {
            display: inline-block;
            padding: 8px 20px;
            background-color: #FFC000;
            border: 2px solid #000000;
            border-radius: 5px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            text-decoration: none;
            color: #000000;
            text-align: center;
            margin-left: 10px;
            /* 添加安卓兼容的樣式 */
            -webkit-appearance: none;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            /* 確保按鈕在安卓上可見 */
            min-height: 36px;
            line-height: 36px;
            vertical-align: middle;
            /* 防止按钮超出边界 */
            box-sizing: border-box;
            /* 确保按钮在安卓上正确渲染 */
            -webkit-transform: translateZ(0);
            transform: translateZ(0);
            /* 文字在按钮内居中 */
            text-align: center;
            /* 使用line-height实现垂直居中 */
            line-height: 36px;
            /* 确保按钮内容完全居中 */
            padding: 8px 20px;
        }
        .ar-button:hover {
            background-color: #FFD133;
        }
        .ar-button:active {
            background-color: #E6AC00;
            transform: translateY(1px);
        }
        .blue-button {
            background-color: #0074D9;
            color: #fff;
            border: 2px solid #000000;
        }
        .blue-button:hover {
            background-color: #339CFF;
        }
        .blue-button:active {
            background-color: #0056B3;
        }
        /* 添加安卓特定的樣式 */
        @media screen and (-webkit-min-device-pixel-ratio: 0) {
            .ar-button {
                -webkit-transform: translateZ(0);
                transform: translateZ(0);
            }
        }
        /* 確保按鈕在各種設備上都能正確顯示 */
        @media (max-width: 768px) {
            .button-container {
                bottom: 15px;
                right: 15px;
                max-width: 280px;
                /* 确保在小屏幕上按钮不会超出边界 */
                max-height: calc(100vh - 30px);
            }
            .ar-button {
                padding: 6px 16px;
                font-size: 16px;
                margin-left: 8px;
                /* 确保按钮在小屏幕上正确显示 */
                max-width: calc(50vw - 30px);
                /* 保持文字居中 */
                text-align: center;
                line-height: 32px;
                min-height: 32px;
            }
        }
        
        /* 安卓设备特殊处理 */
        @media screen and (max-width: 1024px) {
            .button-container {
                /* 使用更安全的定位方式 */
                position: fixed;
                bottom: env(safe-area-inset-bottom, 20px);
                right: env(safe-area-inset-right, 20px);
                /* 确保按钮容器不会超出视口 */
                max-width: min(300px, calc(100vw - 40px));
                max-height: min(200px, calc(100vh - 40px));
            }
            
            .yellow-row, .blue-row {
                /* 确保行内容适应容器宽度 */
                max-width: 100%;
                overflow: hidden;
            }
            
            .ar-button {
                /* 确保按钮适应行宽度 */
                max-width: calc((100% - 20px) / 2);
                min-width: 80px;
                /* 防止按钮文字溢出 */
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                /* 保持文字居中 */
                text-align: center;
                line-height: 36px;
                min-height: 36px;
            }
        }
        
        /* 超小屏幕设备处理 */
        @media (max-width: 480px) {
            .button-container {
                bottom: 10px;
                right: 10px;
                max-width: calc(100vw - 20px);
            }
            
            .ar-button {
                padding: 5px 12px;
                font-size: 14px;
                margin-left: 5px;
                min-width: 60px;
                /* 保持文字居中 */
                text-align: center;
                line-height: 28px;
                min-height: 28px;
            }
            
            .yellow-row, .blue-row {
                margin-bottom: 5px;
            }
        }
        
        /* 横屏模式处理 */
        @media (orientation: landscape) and (max-height: 500px) {
            .button-container {
                bottom: 10px;
                right: 10px;
                max-height: calc(100vh - 20px);
            }
            
            .ar-button {
                padding: 6px 16px;
                min-height: 30px;
                /* 保持文字居中 */
                text-align: center;
                line-height: 30px;
            }
        }
    </style>

    <!-- 直接在頭部定義手勢處理腳本 -->
    <script>
        AFRAME.registerComponent('gesture-handler', {
            schema: {
                enabled: { default: true },
                rotationFactor: { default: 5 },
                minScale: { default: 0.3 },
                maxScale: { default: 8 },
            },

            init: function() {
                this.handleScale = this.handleScale.bind(this);
                this.handleRotation = this.handleRotation.bind(this);

                this.isVisible = false;
                this.initialScale = this.el.object3D.scale.clone();
                this.scaleFactor = 1;

                this.el.sceneEl.addEventListener('touchstart', this.handleRotation);
                this.el.sceneEl.addEventListener('touchmove', this.handleRotation);
                this.el.sceneEl.addEventListener('touchend', this.handleRotation);
                
                this.el.sceneEl.addEventListener('gesturestart', this.handleScale);
                this.el.sceneEl.addEventListener('gesturechange', this.handleScale);
                this.el.sceneEl.addEventListener('gestureend', this.handleScale);
            },

            handleRotation: function(event) {
                if (event.touches.length === 1) {
                    if (event.type === 'touchstart') {
                        this.rotationStart = {
                            x: event.touches[0].pageX,
                            y: event.touches[0].pageY
                        };
                    } else if (event.type === 'touchmove' && this.rotationStart) {
                        const deltaX = event.touches[0].pageX - this.rotationStart.x;
                        const deltaY = event.touches[0].pageY - this.rotationStart.y;
                        
                        this.el.object3D.rotation.y += deltaX * 0.01 * this.data.rotationFactor;
                        this.el.object3D.rotation.x += deltaY * 0.01 * this.data.rotationFactor;
                        
                        this.rotationStart = {
                            x: event.touches[0].pageX,
                            y: event.touches[0].pageY
                        };
                    }
                }
            },

            handleScale: function(event) {
                if (event.type === 'gesturechange') {
                    const newScaleFactor = this.scaleFactor * event.scale;
                    
                    const validScale = Math.min(
                        Math.max(this.data.minScale, newScaleFactor),
                        this.data.maxScale
                    );

                    this.el.object3D.scale.x = this.initialScale.x * validScale;
                    this.el.object3D.scale.y = this.initialScale.y * validScale;
                    this.el.object3D.scale.z = this.initialScale.z * validScale;
                } else if (event.type === 'gestureend') {
                    this.scaleFactor = this.el.object3D.scale.x / this.initialScale.x;
                }
            }
        });
    </script>
</head>
<body>
    <!-- 按鈕容器 -->
    <div class="button-container" id="buttonContainer">
        <div class="yellow-row">
            <a href="https://website.hle.com.tw/ema/ar/prism32/index.html" class="ar-button">頂點</a>
            <a href="https://website.hle.com.tw/ema/ar/prism33/index.html" class="ar-button">邊</a>
        </div>
        <div class="blue-row">
            <a href="https://website.hle.com.tw/ema/ar/prism41/index.html" class="ar-button blue-button">四角柱</a>
            <a href="https://website.hle.com.tw/ema/ar/prism51/index.html" class="ar-button blue-button">五角柱</a>
            <a href="https://website.hle.com.tw/ema/ar/prism61/index.html" class="ar-button blue-button">六角柱</a>
        </div>
    </div>

    <a-scene mindar-image="imageTargetSrc: ./targets.mind; 
             autoStart: true;
             filterMinCF: 0.001;
             filterBeta: 0.01;
             warmupTolerance: 5;
             missTolerance: 5" 
             color-space="sRGB" 
             renderer="colorManagement: true, physicallyCorrectLights" 
             vr-mode-ui="enabled: false" 
             device-orientation-permission-ui="enabled: false"
             embedded>
        
        <a-camera position="0 0 0" look-controls="enabled: false" cursor="fuse: false; rayOrigin: mouse;"></a-camera>

        <!-- 保留單一目標圖片和模型 -->
        <a-entity mindar-image-target="targetIndex: 0">
            <a-gltf-model id="model" 
                         class="clickable"
                         src="./assets/model.glb" 
                         position="0 0 0" 
                         scale="0.5 0.5 0.5"
                         rotation="0 0 0"
                         animation-mixer
                         gesture-handler></a-gltf-model>
        </a-entity>
    </a-scene>

    <script>
        // 改進的按鈕顯示邏輯 - 提高安卓兼容性
        const buttonContainer = document.getElementById('buttonContainer');
        const sceneEl = document.querySelector('a-scene');
        
        // 檢測設備類型
        function isAndroid() {
            return /Android/i.test(navigator.userAgent);
        }
        
        // 檢測設備類型
        function isIOS() {
            return /iPad|iPhone|iPod/.test(navigator.userAgent);
        }
        
        // 強制顯示按鈕的函數
        function forceShowButtons() {
            console.log('強制顯示按鈕');
            buttonContainer.style.display = 'block';
            buttonContainer.style.visibility = 'visible';
            buttonContainer.style.opacity = '1';
            
            // 為安卓設備添加額外的樣式
            if (isAndroid()) {
                buttonContainer.style.position = 'fixed';
                buttonContainer.style.zIndex = '9999';
                // 確保按鈕在安卓上始終可見
                buttonContainer.setAttribute('data-visible', 'true');
                
                // 计算并设置按钮位置，确保在视口内
                adjustButtonPosition();
            }
        }
        
        // 新增：调整按钮位置函数
        function adjustButtonPosition() {
            if (!isAndroid()) return;
            
            console.log('调整按钮位置');
            
            // 获取视口尺寸
            const viewportWidth = window.innerWidth || document.documentElement.clientWidth;
            const viewportHeight = window.innerHeight || document.documentElement.clientHeight;
            
            // 获取按钮容器尺寸
            const buttonRect = buttonContainer.getBoundingClientRect();
            const buttonWidth = buttonRect.width;
            const buttonHeight = buttonRect.height;
            
            // 计算安全位置
            let bottom = 20;
            let right = 20;
            
            // 确保按钮不会超出右边界
            if (right + buttonWidth > viewportWidth) {
                right = Math.max(10, viewportWidth - buttonWidth - 10);
            }
            
            // 确保按钮不会超出下边界
            if (bottom + buttonHeight > viewportHeight) {
                bottom = Math.max(10, viewportHeight - buttonHeight - 10);
            }
            
            // 应用新位置
            buttonContainer.style.bottom = bottom + 'px';
            buttonContainer.style.right = right + 'px';
            
            console.log('按钮位置调整完成:', { bottom, right, viewportWidth, viewportHeight });
        }
        
        // 新增：视口变化处理
        function handleViewportChange() {
            if (isAndroid() && buttonsShown) {
                console.log('视口变化，重新调整按钮位置');
                setTimeout(adjustButtonPosition, 100);
            }
        }
        
        // 监听视口变化
        window.addEventListener('resize', handleViewportChange);
        window.addEventListener('orientationchange', function() {
            console.log('设备方向改变');
            setTimeout(handleViewportChange, 500);
        });
        
        // 监听滚动事件（防止意外滚动）
        window.addEventListener('scroll', function() {
            if (isAndroid()) {
                // 在安卓设备上阻止页面滚动
                window.scrollTo(0, 0);
            }
        });
        
        // 监听触摸事件，防止意外滚动
        document.addEventListener('touchmove', function(e) {
            if (isAndroid() && buttonsShown) {
                // 只允许在按钮区域内的触摸滚动
                const touch = e.touches[0];
                const buttonRect = buttonContainer.getBoundingClientRect();
                
                if (touch.clientX < buttonRect.left || 
                    touch.clientX > buttonRect.right || 
                    touch.clientY < buttonRect.top || 
                    touch.clientY > buttonRect.bottom) {
                    e.preventDefault();
                }
            }
        }, { passive: false });

        // 监听模型加载
        document.querySelector('#model').addEventListener('model-loaded', function() {
            console.log('模型已加載');
        });

        // 改進的事件監聽器 - 多重觸發機制
        let buttonsShown = false;
        let permissionGranted = false;
        
        // 當場景準備就緒時
        sceneEl.addEventListener('arReady', function() {
            console.log('AR 系統準備就緒');
            permissionGranted = true;
            if (!buttonsShown) {
                forceShowButtons();
                buttonsShown = true;
            }
        });

        // 當場景出錯時
        sceneEl.addEventListener('arError', function(ev) {
            console.log('AR 系統錯誤:', ev);
            // 即使出錯也嘗試顯示按鈕
            if (!buttonsShown) {
                forceShowButtons();
                buttonsShown = true;
            }
        });
        
        // 當場景加載完成時
        sceneEl.addEventListener('loaded', function() {
            console.log('場景已加載');
            // 延遲顯示按鈕，確保所有組件都已準備就緒
            setTimeout(function() {
                if (!buttonsShown) {
                    forceShowButtons();
                    buttonsShown = true;
                }
            }, 2000);
        });
        
        // 當相機權限獲得時
        sceneEl.addEventListener('camera-init', function() {
            console.log('相機已初始化');
            permissionGranted = true;
            if (!buttonsShown) {
                forceShowButtons();
                buttonsShown = true;
            }
        });
        
        // 當相機權限狀態改變時
        sceneEl.addEventListener('camera-permission-granted', function() {
            console.log('相機權限已獲得');
            permissionGranted = true;
            // 權限獲得後立即顯示按鈕
            setTimeout(function() {
                forceShowButtons();
                buttonsShown = true;
            }, 100);
        });
        
        // 新增：監聽相機權限被拒絕
        sceneEl.addEventListener('camera-permission-denied', function() {
            console.log('相機權限被拒絕');
            // 即使權限被拒絕也顯示按鈕
            setTimeout(function() {
                forceShowButtons();
                buttonsShown = true;
            }, 100);
        });
        
        // 新增：監聽AR系統狀態變化
        sceneEl.addEventListener('renderstart', function() {
            console.log('AR 渲染開始');
            // 確保按鈕在渲染過程中保持可見
            if (permissionGranted && !buttonsShown) {
                setTimeout(function() {
                    forceShowButtons();
                    buttonsShown = true;
                }, 500);
            }
        });
        
        // 新增：監聽AR系統暫停和恢復
        sceneEl.addEventListener('pause', function() {
            console.log('AR 系統暫停');
        });
        
        sceneEl.addEventListener('play', function() {
            console.log('AR 系統恢復');
            // 系統恢復後確保按鈕可見
            if (permissionGranted) {
                setTimeout(function() {
                    forceShowButtons();
                    buttonsShown = true;
                }, 300);
            }
        });
        
        // 備用方案：如果所有事件都沒有觸發，在頁面加載後強制顯示按鈕
        window.addEventListener('load', function() {
            console.log('頁面已完全加載');
            setTimeout(function() {
                if (!buttonsShown) {
                    console.log('使用備用方案顯示按鈕');
                    forceShowButtons();
                    buttonsShown = true;
                }
                
                // 安卓设备：确保按钮位置正确
                if (isAndroid()) {
                    setTimeout(adjustButtonPosition, 500);
                }
            }, 3000);
        });
        
        // 額外的安卓兼容性檢查
        if (isAndroid()) {
            console.log('檢測到安卓設備，啟用特殊處理');
            
            // 監聽權限變化
            if (navigator.permissions) {
                navigator.permissions.query({name: 'camera'}).then(function(result) {
                    result.onchange = function() {
                        console.log('相機權限狀態變化:', result.state);
                        if (result.state === 'granted') {
                            permissionGranted = true;
                            setTimeout(function() {
                                forceShowButtons();
                                buttonsShown = true;
                            }, 200);
                        }
                    };
                });
            }
            
            // 為安卓設備添加額外的樣式檢查
            document.addEventListener('DOMContentLoaded', function() {
                setTimeout(function() {
                    if (buttonContainer.style.display === 'none' || buttonContainer.style.display === '') {
                        console.log('安卓設備：強制顯示按鈕');
                        forceShowButtons();
                        buttonsShown = true;
                    }
                }, 1000);
            });
            
            // 監聽頁面可見性變化
            document.addEventListener('visibilitychange', function() {
                if (!document.hidden) {
                    console.log('頁面重新可見');
                    // 頁面重新可見時檢查按鈕狀態
                    setTimeout(function() {
                        if (permissionGranted && !buttonsShown) {
                            forceShowButtons();
                            buttonsShown = true;
                        }
                    }, 500);
                }
            });
            
            // 監聽窗口焦點變化
            window.addEventListener('focus', function() {
                console.log('窗口獲得焦點');
                setTimeout(function() {
                    if (permissionGranted && !buttonsShown) {
                        forceShowButtons();
                        buttonsShown = true;
                    }
                }, 300);
            });
        }
        
        // 確保按鈕在各種情況下都能顯示
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden && !buttonsShown) {
                setTimeout(function() {
                    forceShowButtons();
                    buttonsShown = true;
                }, 500);
            }
        });
        
        // 新增：定期檢查按鈕可見性
        setInterval(function() {
            if (permissionGranted && buttonsShown) {
                // 檢查按鈕是否真的可見
                const computedStyle = window.getComputedStyle(buttonContainer);
                if (computedStyle.display === 'none' || computedStyle.visibility === 'hidden') {
                    console.log('檢測到按鈕被隱藏，重新顯示');
                    forceShowButtons();
                }
                
                // 安卓设备：检查按钮位置是否正确
                if (isAndroid()) {
                    const buttonRect = buttonContainer.getBoundingClientRect();
                    const viewportWidth = window.innerWidth || document.documentElement.clientWidth;
                    const viewportHeight = window.innerHeight || document.documentElement.clientHeight;
                    
                    // 如果按钮超出视口，重新调整位置
                    if (buttonRect.right > viewportWidth || buttonRect.bottom > viewportHeight || 
                        buttonRect.left < 0 || buttonRect.top < 0) {
                        console.log('检测到按钮位置超出视口，重新调整');
                        adjustButtonPosition();
                    }
                }
            }
        }, 2000);
        
        // 新增：防止按鈕被AR系統覆蓋
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                    if (permissionGranted && buttonsShown) {
                        const target = mutation.target;
                        if (target === buttonContainer || target.contains(buttonContainer)) {
                            const computedStyle = window.getComputedStyle(buttonContainer);
                            if (computedStyle.display === 'none' || computedStyle.visibility === 'hidden') {
                                console.log('檢測到按鈕樣式被修改，重新設置');
                                setTimeout(function() {
                                    forceShowButtons();
                                }, 100);
                            }
                        }
                    }
                }
            });
        });
        
        // 開始監聽DOM變化
        observer.observe(document.body, {
            attributes: true,
            subtree: true,
            attributeFilter: ['style']
        });
    </script>
</body>
</html>
